#!/bin/sh
ds=`date +'%Y-%m-%d %T'`
versds=`date +'%Y.%m.%d'`
versionfile=version.php

################################################################################
git_update(){
    # look for existing git tag with same name, if not, then add and commit
    echo "Searching for existing git tags matching v$versds "
    git tag | grep -E "^v$versds"
    if [ $? -eq 0 ]; then
        echo "tag by that name already found, skipping git tag"
    else
        echo "no tag with that name yet, committing version number and tag, "
        git add $versionfile
        git commit -m "Updating version number to $versds"
        git tag -a v$versds -m "Updating version number to $versds"  
        # dont want to actually push here, lets leave that to the user
        # git push
    fi
}
################################################################################
version_prep(){
    # try to get to the correct directory in case we are running from somewhere else
    fullpath=`which $0`
    if [ "$fullpath" ]; then
        echo "fullpath = $fullpath"
        dirn=`dirname $fullpath` 
        cd $dirn
        cd ..
    fi
    
    # check that structure is legit
    if test  ! -d bin -o ! -d scheduling -o ! -d workflow ; then
        echo "cant seem to determine location"
    fi
    
    # verify that we have a version file to update
    if [ ! -f $versionfile ]; then
        echo "version file not found"
        exit
    fi
}
################################################################################
create_version_file(){
    yfile=$(/bin/ls -rt *.php inc/*.php | grep -v version.php | tail -1)
    echo "using command to generate: bin/datestamp-from-file $yfile"
    versds=$(bin/datestamp-from-file.py $yfile)
    echo "got the following date string from $yfile: $versds"
    chmod 644 $versionfile
    printf "<?php\n  // version generated by $0 on $ds\n  \$GLOBALS['version'] = '$versds';\n?>\n" > $versionfile
    chmod 644 $versionfile
}
#
version_prep
create_version_file
git_update

